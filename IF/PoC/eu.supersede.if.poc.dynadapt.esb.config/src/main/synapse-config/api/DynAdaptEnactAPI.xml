<?xml version="1.0" encoding="UTF-8"?>
<api context="/enactment" name="DynAdaptEnactAPI" xmlns="http://ws.apache.org/ns/synapse">
  <resource methods="POST" protocol="http" uri-template="/triggerAdaptationDecision/{decisionId}/{systemId}">
    <inSequence>
      <log level="full">
        <property name="Enactment Message" value="triggerAdaptationDecision message forwarded to Enactment"/>
      </log>
      <sequence key="conf:/SupersedeAuthentication.xml"/>
      <property name="endpoint" scope="default" type="STRING" value="gov:/repository/endpoint/Enactment_triggerAdaptationDecisionsEndpoint.xml"/>
      <send>
        <endpoint key-expression="$ctx:endpoint"/>
      </send>
    </inSequence>
    <outSequence>
      <send/>
    </outSequence>
    <faultSequence>
      <send/>
    </faultSequence>
  </resource>
  <resource methods="POST" protocol="http" uri-template="/triggerTopRankedAdaptationDecision/{systemId}">
    <inSequence>
      <log level="full">
        <property name="Enactment Message" value="triggerTopRankedAdaptationDecision message forwarded to Enactment"/>
      </log>
      <!--  <sequence key="conf:/SupersedeAuthentication.xml"/>  -->
      <payloadFactory media-type="json">
        <format>
    		{
        		"uuid" : "$1",
            	"decisionName" : "$2",
            	"decisionDescription" : "$3",
            	"priority" : "$4",
            	"supervisionRequired" : "$5",
            	"status" : "0"
            }
        </format>
        <args>
          <arg evaluator="json" expression="$.id"/>
          <arg evaluator="json" expression="$.name"/>
          <arg evaluator="json" expression="$.description"/>
          <arg evaluator="json" expression="$.priority"/>
          <arg evaluator="json" expression="$.supervised"/>
        </args>
      </payloadFactory>
      <log level="full">
        <property name="Modified Enactment Message" value="triggerTopRankedAdaptationDecision modified message forwarded to Enactment"/>
      </log>
      <property name="endpoint" scope="default" type="STRING" value="gov:/repository/endpoint/Enactment_triggerTopRankedAdaptationDecisionsEndpoint.xml"/>
      <send>
        <endpoint key-expression="$ctx:endpoint"/>
      </send>
    </inSequence>
    <outSequence>
      <send/>
    </outSequence>
    <faultSequence>
      <send/>
    </faultSequence>
  </resource>
  <resource methods="POST" protocol="http" uri-template="/triggerTopRankedAdaptationDecisionAsXML/{systemId}">
    <inSequence>
      <log level="full">
        <property name="Enactment Message" value="triggerTopRankedAdaptationDecisionAsXML message forwarded to Enactment"/>
      </log>
      <!--  <sequence key="conf:/SupersedeAuthentication.xml"/>  -->
      <property name="endpoint" scope="default" type="STRING" value="gov:/repository/endpoint/Enactment_triggerTopRankedAdaptationDecisionAsXMLEndpoint.xml"/>
      <property description="HTTP_Accept"
        expression="get-property('transport','Accept')"
        name="http_accept" scope="default" type="STRING"/>
      <property description="HTTP_Content_Type"
        expression="get-property('transport','Content-Type')"
        name="http_content_type" scope="default" type="STRING"/>
      <filter regex="application/json" source="get-property('http_content_type')">
        <then>
          <header name="Content-Type" scope="transport" value="application/xml"/>
          <header name="Accept" scope="transport" value="application/xml"/>
          <payloadFactory media-type="xml">
            <format>
              <AdaptationDecision xmlns="">
                <id>$1</id>
                <name>$2</name>
                <description>$3</description>
                <supervised>$4</supervised>
                <priority>$5</priority>
              </AdaptationDecision>
            </format>
            <args>
              <arg evaluator="json" expression="$.id"/>
              <arg evaluator="json" expression="$.name"/>
              <arg evaluator="json" expression="$.description"/>
              <arg evaluator="json" expression="$.supervised"/>
              <arg evaluator="json" expression="$.priority"/>
            </args>
          </payloadFactory>
          <log level="full">
            <property name="HTTP_HEADER_CONTENT_TYPE" value="HTTP Header Content-Type changed to application/xml as requested by endpoint"/>
          </log>
        </then>
        <else>
          <log level="full">
            <property name="HTTP_HEADER_CONTENT_TYPE" value="HTTP header Content-Type unchanged"/>
          </log>
        </else>
      </filter>
      <send>
        <endpoint key-expression="$ctx:endpoint"/>
      </send>
    </inSequence>
    <outSequence>
      <log level="full"/>
      <filter regex="application/json" source="get-property('http_accept')">
        <then>
          <payloadFactory media-type="json">
            <format>
				$1
            </format>
            <args>
              <arg evaluator="json" expression="AdaptationDecision"/>
            </args>
          </payloadFactory>
          <log level="full">
            <property name="JSON_PAYLOAD" value="Payload transformed to JSON "/>
          </log>
        </then>
        <else>
          <log>
            <property name="XML_PAYLOAD" value="XML payload unchanged"/>
          </log>
        </else>
      </filter>
      <send/>
    </outSequence>
    <faultSequence>
      <send/>
    </faultSequence>
  </resource>
</api>
